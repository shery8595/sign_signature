<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Signature Guestbook</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(to bottom, #f97316, #facc15);
      min-height: 100vh;
      font-family: 'Arial', sans-serif;
    }
    .signature-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    canvas {
      border: 2px solid #f97316;
      background: white;
      border-radius: 4px;
    }
    .profile-pic {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center p-4">
  <div class="max-w-2xl w-full text-center">
    <h1 class="text-4xl font-bold text-white mb-6">Digital Signature Guestbook</h1>
    <p class="text-lg text-white mb-8">Sign in with Twitter/X to draw your signature!</p>

    <div id="auth-section" class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <button 
        id="loginBtn" 
        class="bg-blue-500 text-white font-semibold py-2 px-4 rounded hover:bg-blue-600 transition"
      >
        Sign in with Twitter/X
      </button>
      <button 
        id="logoutBtn" 
        class="hidden bg-gray-500 text-white font-semibold py-2 px-4 rounded hover:bg-gray-600 transition"
      >
        Sign Out
      </button>
      <div id="userInfo" class="hidden mt-4">
        <img id="profilePic" class="profile-pic inline-block mr-2" alt="Profile Picture">
        <span id="username" class="font-semibold"></span>
      </div>
      <canvas id="signatureCanvas" width="600" height="200" class="w-full mt-4"></canvas>
      <div class="flex gap-4 mt-4">
        <button 
          id="saveBtn" 
          class="bg-orange-500 text-white font-semibold py-2 px-4 rounded hover:bg-orange-600 transition"
        >
          Save Signature
        </button>
        <button 
          id="clearBtn" 
          class="bg-gray-500 text-white font-semibold py-2 px-4 rounded hover:bg-gray-600 transition"
        >
          Clear
        </button>
      </div>
    </div>

    <div id="signatures" class="mt-8">
      <h2 class="text-2xl font-semibold text-white mb-4">Signatures</h2>
      <div id="signature-list" class="grid grid-cols-1 gap-4"></div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Canvas drawing setup with orange ink
    ctx.strokeStyle = '#f97316';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';

    // Mouse events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Touch events
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      startDrawing({ clientX: touch.clientX, clientY: touch.clientY });
    });
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      draw({ clientX: touch.clientX, clientY: touch.clientY });
    });
    canvas.addEventListener('touchend', stopDrawing);

    function startDrawing(e) {
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      lastX = e.clientX - rect.left;
      lastY = e.clientY - rect.top;
    }

    function draw(e) {
      if (!isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x;
      lastY = y;
    }

    function stopDrawing() {
      isDrawing = false;
    }

    // Load signatures from localStorage
    const signatures = JSON.parse(localStorage.getItem('signatures')) || [];

    // Display signatures
    function displaySignatures() {
      const signatureList = document.getElementById('signature-list');
      signatureList.innerHTML = '';
      signatures.forEach(sig => {
        const div = document.createElement('div');
        div.className = 'signature-card';
        div.innerHTML = `
          <div class="flex items-center">
            <img src="${sig.profilePic}" class="profile-pic mr-2" alt="Profile Picture">
            <p class="font-semibold">${sig.username}</p>
          </div>
          <img src="${sig.signature}" alt="Signature" class="max-w-full h-auto">
          <p class="text-sm text-gray-500">${sig.date}</p>
        `;
        signatureList.appendChild(div);
      });
    }

    // Twitter/X OAuth 2.0 with PKCE
    const clientId = 'UUY5SENHNllHejJZeU1vVlNlSjM6MTpjaQ'; // Replace with your Twitter Client ID
    const redirectUri = 'https://sign-signature.vercel.app/api/callback';
    const scope = 'users.read';

    function generateCodeVerifier() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return btoa(String.fromCharCode.apply(null, array))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
    }

    function generateCodeChallenge(verifier) {
      return crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier))
        .then(buffer => {
          const array = new Uint8Array(buffer);
          return btoa(String.fromCharCode.apply(null, array))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=/g, '');
        });
    }

    async function initiateLogin() {
      const codeVerifier = generateCodeVerifier();
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const authUrl = `https://api.twitter.com/2/oauth2/authorize?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&code_challenge=${codeChallenge}&code_challenge_method=S256`;
      window.location.href = authUrl;
    }

    // Handle login button
    document.getElementById('loginBtn').addEventListener('click', initiateLogin);

    // Handle logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user_data');
      document.getElementById('loginBtn').classList.remove('hidden');
      document.getElementById('logoutBtn').classList.add('hidden');
      document.getElementById('userInfo').classList.add('hidden');
      document.getElementById('signatureCanvas').classList.add('hidden');
      document.getElementById('saveBtn').classList.add('hidden');
      document.getElementById('clearBtn').classList.add('hidden');
    });

    // Save signature
    document.getElementById('saveBtn').addEventListener('click', () => {
      const userData = JSON.parse(localStorage.getItem('user_data'));
      if (!userData) {
        alert('Please sign in with Twitter/X first.');
        return;
      }
      const signature = canvas.toDataURL('image/png');
      const date = new Date().toLocaleString();
      signatures.push({
        username: userData.username,
        profilePic: userData.profile_image_url,
        signature,
        date
      });
      localStorage.setItem('signatures', JSON.stringify(signatures));
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      displaySignatures();
    });

    // Clear canvas
    document.getElementById('clearBtn').addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // Check for access token and fetch user data
    async function checkAuth() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        // Exchange code for token via serverless function with code_verifier
        const codeVerifier = localStorage.getItem('code_verifier'); // Retrieve from localStorage
        const response = await fetch(`/api/callback?code=${code}&code_verifier=${encodeURIComponent(codeVerifier)}`);
        const data = await response.json();
        if (data.access_token) {
          localStorage.setItem('access_token', data.access_token);
          // Fetch user data
          const userResponse = await fetch('https://api.twitter.com/2/users/me?user.fields=profile_image_url', {
            headers: { 'Authorization': `Bearer ${data.access_token}` }
          });
          const userData = await userResponse.json();
          localStorage.setItem('user_data', JSON.stringify(userData.data));
          document.getElementById('loginBtn').classList.add('hidden');
          document.getElementById('logoutBtn').classList.remove('hidden');
          document.getElementById('userInfo').classList.remove('hidden');
          document.getElementById('profilePic').src = userData.data.profile_image_url;
          document.getElementById('username').textContent = userData.data.username;
          document.getElementById('signatureCanvas').classList.remove('hidden');
          document.getElementById('saveBtn').classList.remove('hidden');
          document.getElementById('clearBtn').classList.remove('hidden');
          // Clear URL params and code_verifier
          localStorage.removeItem('code_verifier');
          window.history.replaceState({}, document.title, window.location.pathname);
        } else {
          console.error('Token exchange failed:', data.error);
        }
      } else if (localStorage.getItem('access_token') && localStorage.getItem('user_data')) {
        const userData = JSON.parse(localStorage.getItem('user_data'));
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('profilePic').src = userData.profile_image_url;
        document.getElementById('username').textContent = userData.username;
        document.getElementById('signatureCanvas').classList.remove('hidden');
        document.getElementById('saveBtn').classList.remove('hidden');
        document.getElementById('clearBtn').classList.remove('hidden');
      }
    }

    // Initial setup
    checkAuth();
    displaySignatures();
  </script>
</body>
</html>
