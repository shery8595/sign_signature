<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Signature</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(to bottom, #f97316, #facc15);
      min-height: 100vh;
      font-family: 'Arial', sans-serif;
    }
    .signature-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    canvas {
      border: 2px solid #f97316;
      background: white;
      border-radius: 4px;
      cursor: crosshair;
    }
    .profile-pic {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }
    .error-message {
      color: red;
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center p-4">
  <div class="max-w-2xl w-full text-center">
    <h1 class="text-4xl font-bold text-white mb-6">Sign Your Signature</h1>
    <p class="text-lg text-white mb-8">Sign in with Twitter/X to draw your signature!</p>

    <div id="auth-section" class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <button 
        id="connectBtn" 
        class="bg-blue-500 text-white font-semibold py-2 px-4 rounded hover:bg-blue-600 transition"
      >
        Connect Twitter/X
      </button>
      <button 
        id="logoutBtn" 
        class="hidden bg-gray-500 text-white font-semibold py-2 px-4 rounded hover:bg-gray-600 transition"
      >
        Sign Out
      </button>
      <div id="profile" class="hidden mt-4">
        <img id="profilePic" class="profile-pic inline-block mr-2" alt="Profile Picture">
        <span id="username" class="font-semibold"></span>
      </div>
      <div id="error" class="error-message hidden"></div>
      <canvas id="canvas" width="600" height="200" class="w-full mt-4 hidden"></canvas>
      <div class="flex gap-4 mt-4">
        <button 
          id="saveBtn" 
          class="bg-orange-500 text-white font-semibold py-2 px-4 rounded hover:bg-orange-600 transition hidden"
        >
          Save Signature
        </button>
        <button 
          id="clearBtn" 
          class="bg-gray-500 text-white font-semibold py-2 px-4 rounded hover:bg-gray-600 transition hidden"
        >
          Clear
        </button>
      </div>
    </div>

    <div id="signatures" class="mt-8">
      <h2 class="text-2xl font-semibold text-white mb-4">Signatures</h2>
      <div id="signature-list" class="grid grid-cols-1 gap-4"></div>
    </div>
  </div>

  <script>
    const clientId = "UUY5SENHNllHejJZeU1vVlNlSjM6MTpjaQ";
    const redirectUri = "https://sign-signature.vercel.app/api/callback";
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    let lastX = 0;
    let lastY = 0;

    // Canvas drawing setup with orange ink
    ctx.strokeStyle = "#f97316";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";

    // Mouse events
    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("mouseout", stopDrawing);

    // Touch events
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      startDrawing({ clientX: touch.clientX, clientY: touch.clientY });
    });
    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      draw({ clientX: touch.clientX, clientY: touch.clientY });
    });
    canvas.addEventListener("touchend", stopDrawing);

    function startDrawing(e) {
      drawing = true;
      const rect = canvas.getBoundingClientRect();
      lastX = e.clientX - rect.left;
      lastY = e.clientY - rect.top;
    }

    function draw(e) {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x;
      lastY = y;
    }

    function stopDrawing() {
      drawing = false;
    }

    // Twitter OAuth 2.0 with PKCE
    async function connectTwitter() {
      const codeVerifier = generateRandomString(64);
      const csrfToken = crypto.randomUUID();
      const stateObj = { csrf: csrfToken, codeVerifier };
      const state = btoa(JSON.stringify(stateObj));

      localStorage.setItem("csrf", csrfToken);
      localStorage.setItem("code_verifier", codeVerifier);

      const codeChallenge = await generateCodeChallenge(codeVerifier);

      const authUrl = new URL("https://twitter.com/i/oauth2/authorize");
      authUrl.searchParams.set("response_type", "code");
      authUrl.searchParams.set("client_id", clientId);
      authUrl.searchParams.set("redirect_uri", redirectUri);
      authUrl.searchParams.set("scope", "tweet.read users.read");
      authUrl.searchParams.set("state", state);
      authUrl.searchParams.set("code_challenge", codeChallenge);
      authUrl.searchParams.set("code_challenge_method", "S256");

      window.location.href = authUrl.toString();
    }

    function generateRandomString(length) {
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let result = '';
      const array = new Uint8Array(length);
      crypto.getRandomValues(array);
      array.forEach(x => result += charset[x % charset.length]);
      return result;
    }

    async function generateCodeChallenge(codeVerifier) {
      const data = new TextEncoder().encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Handle authentication callback
    async function checkAuth() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");
      const state = urlParams.get("state");
      const errorDiv = document.getElementById("error");

      if (code && state) {
        try {
          const stateObj = JSON.parse(atob(state));
          if (stateObj.csrf !== localStorage.getItem("csrf")) {
            errorDiv.textContent = "Authentication failed: CSRF token mismatch";
            errorDiv.classList.remove("hidden");
            return;
          }
          const codeVerifier = localStorage.getItem("code_verifier");
          if (!codeVerifier) {
            errorDiv.textContent = "Authentication failed: Missing code verifier";
            errorDiv.classList.remove("hidden");
            return;
          }

          const response = await fetch(`/api/callback?code=${code}&code_verifier=${encodeURIComponent(codeVerifier)}`);
          const data = await response.json();
          if (data.access_token) {
            localStorage.setItem("access_token", data.access_token);
            const userResponse = await fetch("https://api.twitter.com/2/users/me?user.fields=profile_image_url", {
              headers: { Authorization: `Bearer ${data.access_token}` }
            });
            if (!userResponse.ok) {
              errorDiv.textContent = "Failed to fetch user data";
              errorDiv.classList.remove("hidden");
              return;
            }
            const userData = await userResponse.json();
            if (!userData.data) {
              errorDiv.textContent = "Invalid user data received";
              errorDiv.classList.remove("hidden");
              return;
            }
            localStorage.setItem("user_data", JSON.stringify(userData.data));
            updateUI(userData.data);
            localStorage.removeItem("csrf");
            localStorage.removeItem("code_verifier");
            window.history.replaceState({}, document.title, window.location.pathname);
          } else {
            errorDiv.textContent = `Token exchange failed: ${data.error || "Unknown error"}`;
            errorDiv.classList.remove("hidden");
          }
        } catch (error) {
          errorDiv.textContent = `Authentication error: ${error.message}`;
          errorDiv.classList.remove("hidden");
          console.error("Authentication error:", error);
        }
      } else if (localStorage.getItem("access_token") && localStorage.getItem("user_data")) {
        const userData = JSON.parse(localStorage.getItem("user_data"));
        updateUI(userData);
      } else {
        errorDiv.textContent = "Please sign in with Twitter/X to continue.";
        errorDiv.classList.remove("hidden");
      }
    }

    function updateUI(userData) {
      document.getElementById("connectBtn").classList.add("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      document.getElementById("profile").classList.remove("hidden");
      document.getElementById("profilePic").src = userData.profile_image_url;
      document.getElementById("username").textContent = userData.username;
      document.getElementById("canvas").classList.remove("hidden");
      document.getElementById("saveBtn").classList.remove("hidden");
      document.getElementById("clearBtn").classList.remove("hidden");
      document.getElementById("error").classList.add("hidden");
    }

    // Handle logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("access_token");
      localStorage.removeItem("user_data");
      document.getElementById("connectBtn").classList.remove("hidden");
      document.getElementById("logoutBtn").classList.add("hidden");
      document.getElementById("profile").classList.add("hidden");
      document.getElementById("canvas").classList.add("hidden");
      document.getElementById("saveBtn").classList.add("hidden");
      document.getElementById("clearBtn").classList.add("hidden");
      document.getElementById("signature-list").innerHTML = "";
      document.getElementById("error").textContent = "Please sign in with Twitter/X to continue.";
      document.getElementById("error").classList.remove("hidden");
    });

    // Save signature
    document.getElementById("saveBtn").addEventListener("click", () => {
      const userData = JSON.parse(localStorage.getItem("user_data"));
      if (!userData) {
        document.getElementById("error").textContent = "Please sign in with Twitter/X first.";
        document.getElementById("error").classList.remove("hidden");
        return;
      }
      const signature = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      link.download = "signature.png";
      link.href = signature;
      link.click();

      // Display the saved signature
      const signatureList = document.getElementById("signature-list");
      signatureList.innerHTML = "";
      const div = document.createElement("div");
      div.className = "signature-card";
      div.innerHTML = `
        <div class="flex items-center">
          <img src="${userData.profile_image_url}" class="profile-pic mr-2" alt="Profile Picture">
          <p class="font-semibold">${userData.username}</p>
        </div>
        <img src="${signature}" alt="Signature" class="max-w-full h-auto">
        <p class="text-sm text-gray-500">${new Date().toLocaleString()}</p>
      `;
      signatureList.appendChild(div);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // Clear canvas
    document.getElementById("clearBtn").addEventListener("click", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // Connect button
    document.getElementById("connectBtn").addEventListener("click", connectTwitter);

    // Initial setup
    checkAuth();
  </script>
</body>
</html>
